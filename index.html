<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INTERFACCE — Chromatic Field</title>
  <style>
    :root {
      --bg: #0b0b0c;
      --fg: #e7e7ea;
      --muted: #9a9aa1;
      --panel: rgba(10,10,12,0.55);
      --accent: #18c6d0;
    }
    html, body { margin: 0; height: 100%; overflow: hidden; background: var(--bg); color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #c { position: fixed; inset: 0; width: 100vw; height: 100vh; display: block; }
    .overlay { position: fixed; inset: 0; pointer-events: none; mix-blend-mode: screen; }
    .grain { position: absolute; inset: -10vmax; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity=".04"/></svg>') repeat; opacity: 0.4; }
    .hud { position: fixed; left: 1rem; bottom: 1rem; pointer-events: auto; background: var(--panel); border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: 14px; padding: 12px 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.35); }
    .hud h1 { font-size: 15px; margin: 0 0 8px; letter-spacing: .08em; text-transform: uppercase; color: var(--fg); opacity: .9 }
    .hud p { margin: 0; font-size: 13px; line-height: 1.3; color: var(--muted); }
    .hud kbd { font: inherit; background: rgba(255,255,255,0.08); padding: 1px 6px; border-radius: 6px; color: var(--fg); border: 1px solid rgba(255,255,255,0.12); }
    .hud .row { display: flex; gap: 12px; align-items: center; margin-top: 8px; }
    .btn { pointer-events: auto; cursor: pointer; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--fg); border-radius: 10px; padding: 8px 10px; font-size: 12px; transition: transform .08s ease, background .2s ease; }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn:active { transform: translateY(1px); }
    .indicators { position: fixed; right: 1rem; top: 1rem; display: grid; gap: 8px; pointer-events: none; }
    .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 0 0 2px rgba(0,0,0,0.25) inset; }
    .dot.on { background: var(--accent); box-shadow: 0 0 20px 4px rgba(24,198,208,0.45); }
    .video { position: fixed; right: 1rem; bottom: 1rem; width: 160px; height: 100px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.35); display:none; }
    .legend { position: fixed; left: 50%; transform: translateX(-50%); bottom: 1rem; font-size: 12px; color: rgba(255,255,255,0.7); letter-spacing: .06em; text-align:center; }
    .pill { display:inline-block; min-width: 12px; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); margin: 0 4px; }
    .hidden { display:none; }
    .lang-switch { position: fixed; right: 1rem; bottom: 1rem; background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 6px; display: inline-flex; gap: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .lang-btn { pointer-events: auto; cursor: pointer; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--fg); border-radius: 8px; padding: 6px 10px; font-size: 12px; }
    .lang-btn.active { background: rgba(255,255,255,0.16); }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div class="overlay"><div class="grain"></div></div>

  <div class="hud" id="hud">
    <h1 id="title"></h1>
    <p id="desc"></p>
    <div class="row">
      <button class="btn" id="micBtn"></button>
      <button class="btn" id="camBtn"></button>
      <button class="btn" id="paletteBtn"></button>
      <button class="btn" id="saveBtn"></button>
    </div>
    <p class="row" style="margin-top:10px">
      <span class="pill" id="pillMute"></span>
      <span class="pill" id="pillHelp"></span>
    </p>
  </div>

  <div class="indicators">
    <div class="dot" id="micDot" title="Microphone"></div>
    <div class="dot" id="camDot" title="Camera"></div>
  </div>

  <video id="v" class="video" autoplay playsinline muted></video>
  <div class="legend" id="legend"></div>
  <div class="lang-switch" id="langSwitch">
    <button class="lang-btn" data-lang="it">ITA</button>
    <button class="lang-btn active" data-lang="en">ENG</button>
  </div>
  <div id="warn" style="position:fixed; top:1rem; left:50%; transform:translateX(-50%); max-width: min(92vw,720px); padding:10px 14px; background: rgba(255,60,60,0.08); color:#fff; border:1px solid rgba(255,60,60,0.35); border-radius:12px; font-size:13px; line-height:1.35; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display:none; z-index:9999; text-align:center"></div>

  <script>
    // --- i18n ---
    const I18N = {
      en: {
        title: 'INTERFACCE — Chromatic Field',
        desc: 'A light landscape reacting to <strong>voice</strong>, <strong>movement</strong> and <strong>presence</strong>.<br/>Move the mouse: <em>refraction</em>. Speak or whistle: <em>chromas</em>. Approach the webcam: <em>temperature</em>.',
        micEnable: 'Enable microphone',
        camEnable: 'Enable webcam',
        micActive: 'Microphone on',
        camActive: 'Webcam on',
        palette: 'Change palette (C)',
        save: 'Save snapshot (S)',
        pillMute: 'M — Mute',
        pillHelp: 'H — Toggle help',
        legend: 'Voice→saturation | Webcam→temperature | Mouse→refraction',
        warnIframe: 'This is an <b>iframe preview</b>: microphone and camera may be blocked by the browser.',
        warnHttps: 'To use microphone/camera open this file over <b>HTTPS</b> or on <b>localhost</b> (e.g. VS Code “Live Server” or <code>python3 -m http.server</code>).' 
      },
      it: {
        title: 'INTERFACCE — Campo Cromatico',
        desc: 'Un paesaggio di luce che reagisce a <strong>voce</strong>, <strong>movimento</strong> e <strong>presenza</strong>.<br/>Muovi il mouse: <em>rifrazione</em>. Parla o fischia: <em>cromie</em>. Avvicinati alla webcam: <em>temperatura</em>.',
        micEnable: 'Attiva microfono',
        camEnable: 'Attiva webcam',
        micActive: 'Microfono attivo',
        camActive: 'Webcam attiva',
        palette: 'Cambia palette (C)',
        save: 'Salva scatto (S)',
        pillMute: 'M — Muta',
        pillHelp: 'H — Mostra/Nascondi aiuti',
        legend: 'Voce→saturazione | Webcam→temperatura | Mouse→rifrazione',
        warnIframe: 'Questa è una <b>preview in iframe</b>: microfono e webcam potrebbero essere bloccati dal browser.',
        warnHttps: 'Per usare microfono/webcam apri questo file via <b>HTTPS</b> oppure su <b>localhost</b> (es. VS Code “Live Server” o <code>python3 -m http.server</code>).' 
      }
    };

    let lang = (navigator.language||'en').toLowerCase().startsWith('it') ? 'it' : 'en';

    function setLang(l){
      lang = l in I18N ? l : 'en';
      document.body.setAttribute('data-lang', lang);
      const t = I18N[lang];
      const el = (id) => document.getElementById(id);
      if (el('title')) el('title').textContent = t.title;
      if (el('desc')) el('desc').innerHTML = t.desc;
      if (el('micBtn')) el('micBtn').textContent = t.micEnable;
      if (el('camBtn')) el('camBtn').textContent = t.camEnable;
      if (el('paletteBtn')) el('paletteBtn').textContent = t.palette;
      if (el('saveBtn')) el('saveBtn').textContent = t.save;
      if (el('pillMute')) el('pillMute').textContent = t.pillMute;
      if (el('pillHelp')) el('pillHelp').textContent = t.pillHelp;
      if (el('legend')) el('legend').textContent = t.legend;
      const warn = document.getElementById('warn');
      if (warn && warn.style.display === 'block') {
        const msgs = [];
        if (window.top !== window.self) msgs.push(I18N[lang].warnIframe);
        if (!window.isSecureContext && location.hostname !== 'localhost') msgs.push(I18N[lang].warnHttps);
        warn.innerHTML = msgs.join(' ');
      }
      document.querySelectorAll('.lang-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.lang===lang);
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.lang-btn').forEach(b => b.addEventListener('click', () => setLang(b.dataset.lang)));
      setLang(lang);
    });
  </script>

  <script>
  // Utility: clamp and lerp
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const lerp = (a, b, t) => a + (b - a) * t;

  // Canvas setup
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false });
  let W, H, DPR;
  function resize() {
    DPR = Math.min(window.devicePixelRatio || 1, 2);
    W = canvas.width = Math.floor(window.innerWidth * DPR);
    H = canvas.height = Math.floor(window.innerHeight * DPR);
  }
  window.addEventListener('resize', resize);
  resize();

  // Interaction state
  let mouse = { x: 0.5, y: 0.5, dx: 0, dy: 0, speed: 0 };
  let t = 0; // time

  window.addEventListener('mousemove', (e) => {
    const nx = e.clientX / window.innerWidth;
    const ny = e.clientY / window.innerHeight;
    mouse.dx = nx - mouse.x;
    mouse.dy = ny - mouse.y;
    mouse.speed = Math.hypot(mouse.dx, mouse.dy);
    mouse.x = nx; mouse.y = ny;
  });

  // Palettes inspired by sodium/ice/lava/aurora color families
  const palettes = [
    // Aurora
    [ [72, 1.0, 0.15], [140, 0.9, 0.55], [190, 0.7, 0.9], [310, 0.5, 0.6] ],
    // Sodium
    [ [30, 0.95, 0.15], [40, 0.9, 0.6], [50, 0.85, 0.95], [20, 0.7, 0.4] ],
    // Ice
    [ [190, 0.35, 0.1], [200, 0.5, 0.5], [210, 0.7, 0.95], [230, 0.6, 0.7] ],
    // Lava
    [ [355, 0.8, 0.15], [10, 0.9, 0.5], [25, 0.95, 0.95], [330, 0.5, 0.5] ],
    // Prism
    [ [0, 0.9, 0.9], [60, 0.9, 0.9], [180, 0.9, 0.9], [300, 0.9, 0.9] ]
  ];
  let paletteIndex = 0;

  function hsl(h, s, l){ return `hsl(${h}, ${Math.round(s*100)}%, ${Math.round(l*100)}%)`; }

  // Audio (microphone) — modulates saturation & noise speed
  let audioEnabled = false;
  let audioSmooth = 0; // 0..1
  let audioCtx, analyser, dataArray;

  async function enableMic(){
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      src.connect(analyser);
      audioEnabled = true;
      document.getElementById('micDot').classList.add('on');
      document.getElementById('micBtn').textContent = I18N[lang].micActive;
    } catch(err){ console.warn('Mic denied', err); }
  }

  function sampleAudio(){
    if(!audioEnabled || !analyser) return 0;
    analyser.getByteFrequencyData(dataArray);
    const nyquist = audioCtx.sampleRate / 2;
    const low = Math.floor(200 / nyquist * dataArray.length);
    const high = Math.min(dataArray.length - 1, Math.floor(2000 / nyquist * dataArray.length));
    let sum = 0;
    for(let i=low;i<=high;i++) sum += dataArray[i];
    const avg = sum / (high - low + 1);
    const level = Math.max(0, Math.min(1, (avg - 30) / 180));
    audioSmooth = lerp(audioSmooth, level, 0.15);
    return audioSmooth;
  }

  // Video (webcam) — extracts average hue → shifts palette temperature
  let videoEnabled = false;
  const v = document.getElementById('v');
  const vcan = document.createElement('canvas');
  const vctx = vcan.getContext('2d');
  let camHue = 0, camLight = 0.5;

  async function enableCam(){
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 180 }, audio: false });
      v.srcObject = stream; v.play();
      videoEnabled = true;
      document.getElementById('camDot').classList.add('on');
      document.getElementById('camBtn').textContent = I18N[lang].camActive;
      v.style.display = 'block';
    } catch(err){ console.warn('Cam denied', err); }
  }

  function sampleVideo(){
    if(!videoEnabled || v.videoWidth === 0) return;
    const w = 64, h = 36;
    vcan.width = w; vcan.height = h;
    vctx.drawImage(v, 0, 0, w, h);
    const img = vctx.getImageData(0, 0, w, h).data;
    let sumH=0, sumL=0, n=0;
    for(let i=0;i<img.length;i+=4){
      const r=img[i]/255, g=img[i+1]/255, b=img[i+2]/255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      let h=0, l=(max+min)/2, d = max-min;
      if(d!==0){
        let s = d / (1 - Math.abs(2*l-1));
        switch(max){ case r: h=((g-b)/d)%6; break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break; }
        h*=60; if(h<0) h+=360;
      }
      sumH += h; sumL += l; n++;
    }
    camHue = (sumH/n)||0; camLight = (sumL/n)||0.5;
  }

  // Noise field (simple 2D value noise)
  function hash(x, y){ let s = Math.sin(x*127.1 + y*311.7) * 43758.5453; return s - Math.floor(s); }
  function noise(x, y){
    const xi = Math.floor(x), yi = Math.floor(y);
    const xf = x - xi, yf = y - yi;
    const tl = hash(xi, yi), tr = hash(xi+1, yi), bl = hash(xi, yi+1), br = hash(xi+1, yi+1);
    const u = xf*xf*(3-2*xf), v = yf*yf*(3-2*yf);
    return lerp(lerp(tl, tr, u), lerp(bl, br, u), v);
  }

  function draw(){
    requestAnimationFrame(draw);
    t += 0.006 + sampleAudio()*0.02;
    sampleVideo();

    const base = palettes[paletteIndex];
    const hueShift = (camHue - 180) * 0.2;
    const satBoost = 0.2 + sampleAudio()*0.6;

    const step = Math.max(2, Math.floor(4 / DPR));
    const scale = 0.0018 * DPR;

    const mx = mouse.x * W, my = mouse.y * H;

    for(let y=0; y<H; y+=step){
      for(let x=0; x<W; x+=step){
        const nx = x*scale, ny = y*scale;
        const f = noise(nx + t*0.6, ny - t*0.5);
        const g = noise(nx*0.7 - t*0.3, ny*0.9 + t*0.2);
        let k = (f*0.6 + g*0.4);

        const dx = (x-mx), dy = (y-my);
        const dist = Math.hypot(dx, dy);
        const lens = Math.exp(-(dist*dist)/(2*Math.pow(220*DPR*(1+mouse.speed*6),2)));
        k = lerp(k, 1 - k, lens*0.8);

        const pA = base[Math.floor(k*base.length) % base.length];
        const pB = base[(Math.floor(k*base.length)+1) % base.length];
        const frac = k*base.length % 1;
        let h = (lerp(pA[0], pB[0], frac) + hueShift + 360) % 360;
        let s = Math.max(0, Math.min(1, lerp(pA[1], pB[1], frac) * (0.7 + satBoost*0.6)));
        let l = Math.max(0, Math.min(1, lerp(pA[2], pB[2], frac) * (0.8 + (camLight-0.5)*0.3)));

        ctx.fillStyle = `hsl(${h}, ${s*100}%, ${l*100}%)`;
        ctx.fillRect(x, y, step, step);
      }
    }
  }
  draw();

  // UI controls
  const hud = document.getElementById('hud');
  const legend = document.getElementById('legend');

  document.getElementById('micBtn').addEventListener('click', enableMic);
  document.getElementById('camBtn').addEventListener('click', enableCam);
  document.getElementById('paletteBtn').addEventListener('click', () => { paletteIndex = (paletteIndex+1) % palettes.length; });
  document.getElementById('saveBtn').addEventListener('click', saveFrame);

  function saveFrame(){
    const a = document.createElement('a');
    a.download = `chromatic-field_${Date.now()}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
  }

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    if(e.key === 'm' || e.key === 'M') {
      if(audioCtx && audioCtx.state === 'running') audioCtx.suspend();
      else if(audioCtx) audioCtx.resume();
    }
    if(e.key === 'c' || e.key === 'C') paletteIndex = (paletteIndex+1) % palettes.length;
    if(e.key === 's' || e.key === 'S') saveFrame();
    if(e.key === 'h' || e.key === 'H') { hud.classList.toggle('hidden'); legend.classList.toggle('hidden'); }
  });

  // Intro pulse
  (function intro(){
    let alpha = 0; const iv = setInterval(()=>{
      alpha += 0.04; document.documentElement.style.setProperty('--accent', `hsla(${Math.floor(lerp(160, 200, alpha))}, 80%, 50%, 1)`);
      if(alpha>=1) clearInterval(iv);
    }, 30);
  })();

  // Environment warnings (iframe / HTTPS)
  (function envWarnings(){
    const warn = document.getElementById('warn');
    let msgs = [];
    if (window.top !== window.self) msgs.push(I18N[lang].warnIframe);
    if (!window.isSecureContext && location.hostname !== 'localhost') msgs.push(I18N[lang].warnHttps);
    if (msgs.length) { warn.innerHTML = msgs.join(' '); warn.style.display = 'block'; }
    if (navigator.permissions && navigator.permissions.query) {
      ['microphone','camera'].forEach(async name => {
        try {
          const st = await navigator.permissions.query({ name });
          const dot = document.getElementById(name === 'microphone' ? 'micDot' : 'camDot');
          function sync(){ dot.title = name + ': ' + st.state; }
          st.onchange = sync; sync();
        } catch(_){}
      });
    }
  })();
  </script>
</body>
</html>
